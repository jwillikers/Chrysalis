app-id: io.keyboard.Chrysalis.Devel
runtime: org.freedesktop.Platform
runtime-version: "20.08"
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: "20.08"
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node14
separate-locales: false
command: chrysalis
finish-args:
  # Chrysalis requires serial console access in order to update firmware and program keyboards.
  - --device=all

  - --device=dri
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --filesystem=xdg-run/pipewire-0
  # If you need to access the filesystem, also add:
  - --filesystem=home
modules:
  - name: yarn
    buildsystem: simple
    build-commands:
      - cp -a * /app
    cleanup:
      - "*"
    sources:
      - type: archive
        url: https://github.com/yarnpkg/yarn/releases/download/v1.22.11/yarn-v1.22.11.tar.gz
        sha256: 2c320de14a6014f62d29c34fec78fdbb0bc71c9ccba48ed0668de452c1f5fe6c
        x-checker-data:
          type: anitya
          project-id: 13363
          url-template: https://github.com/yarnpkg/yarn/releases/download/$version/yarn-v$version.tar.gz
  - name: libusb
    config-opts:
      - --disable-static
    cleanup:
      - /lib/*.la
      - /lib/pkgconfig
      - /include
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/archive/v1.0.24.tar.gz
        sha256: b7724c272dfc5713dce88ff717efd60f021ca5b7c8e30f08ebb2c42d2eea08ae
        x-checker-data:
          type: anitya
          project-id: 1749
          stable-only: true
          url-template: https://github.com/libusb/libusb/archive/v$version.tar.gz
    post-install:
      - install -Dm644 COPYING /app/share/licenses/libusb/COPYING
  - name: udev
    config-opts:
      - --disable-hwdb
      - --disable-logging
      - --disable-gudev
      - --disable-introspection
      - --disable-keymap
      - --disable-mtd_probe
    cleanup:
      - /include
      - /etc
      - /libexec
      - /sbin
      - /lib/pkgconfig
      - /man
      - /share/aclocal
      - /share/doc
      - /share/gtk-doc
      - /share/man
      - /share/pkgconfig
      - "*.la"
      - "*.a"
    sources:
      - type: archive
        url: https://github.com/gentoo/eudev/archive/v3.2.10.tar.gz
        sha256: 6492629da4024d2d21bb1a79d724e013d4152956099a5c63b09c8ee4da7f9b2b
        x-checker-data:
          type: anitya
          project-id: 13466
          stable-only: true
          url-template: https://github.com/gentoo/eudev/archive/v$version.tar.gz

  - name: chrysalis
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node14/bin:/app/yarn/bin
      env:
        DEBUG: electron-builder
        XDG_CACHE_HOME: /run/build/chrysalis/flatpak-node/cache
        npm_config_target: 12.0.0
        # npm_config_build_from_source: true
        # npm_config_nodedir: /usr/lib/sdk/node14
        npm_config_nodedir: /run/build/chrysalis/flatpak-node/cache/node-gyp/12.0.0
        # npm_config_cache: /run/build/chrysalis/flatpak-node/cache/node-gyp/12.0.0
        npm_config_cache: /run/build/chrysalis/flatpak-node/npm-cache
        # YARN_CACHE_FOLDER: /run/build/chrysalis/flatpak-node/yarn-cache
        npm_config_offline: "true"
        npm_config_no_save: "true"
        npm_config_loglevel: verbose
        # https://stackoverflow.com/questions/25146976/can-i-get-npm-gyp-to-use-ccache
        CXX: ccache g++
        CC: ccache gcc
    cleanup:
      - /app/chrysalis/chrysalis
    build-commands:
      - sed -i 's/yarn /yarn --offline /g' package.json

      # Rebuild native modules by electron-rebuild
      # https://github.com/electron-userland/electron-builder/issues/4100
      - sed -i 's/"build":\ {/"build":\ {\n"npmRebuild":\ false,/' package.json

      - HOME=$PWD yarn config --offline set yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror
      - yarn --offline --pure-lockfile

      - yarn --offline compile
      - . flatpak-node/electron-builder-arch-args.sh; yarn --offline run electron-builder --linux dir -c.linux.target=dir $ELECTRON_BUILDER_ARCH_ARGS

      - cp -r dist/linux*unpacked /app/chrysalis
      - install -Dm 755 chrysalis.sh /app/bin/chrysalis
      - install -Dm 644 build/io.keyboard.Chrysalis.desktop /app/share/applications/$FLATPAK_ID.desktop
      - sed -i 's/Icon=io.keyboard.Chrysalis/Icon=io.keyboard.Chrysalis.Devel/' /app/share/applications/$FLATPAK_ID.desktop
      - install -Dm 644 build/io.keyboard.Chrysalis.metainfo.xml /app/share/metainfo/$FLATPAK_ID.metainfo.xml
      - sed -i 's/io.keyboard.Chrysalis.desktop/io.keyboard.Chrysalis.Devel.desktop/' /app/share/metainfo/$FLATPAK_ID.metainfo.xml
      - for size in 64 128; do [[ -e "build/icon-${size}x${size}.png" ]] && install
        -Dm644 "build/icon-${size}x${size}.png" "/app/share/icons/hicolor/${size}x${size}/apps/${FLATPAK_ID}.png";
        done
      - install -Dm 644 build/icon.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
    sources:
      - type: git
        url: ".."
        # todo Change to master when merging.
        branch: flatpak

        # todo Use this in the release manifest.
        # x-checker-data:
        #   type: anitya
        #   project-id: 141547
        #   stable-only: true
        #   tag-template: v$version
      - generated-sources.json
      - type: script
        dest-filename: chrysalis.sh
        commands:
          - if [[ -n "$WAYLAND_DISPLAY" ]]; then set -- --enable-features=UseOzonePlatform --ozone-platform=wayland "$@"; fi
          - zypak-wrapper.sh /app/chrysalis/chrysalis-bin "$@"
